<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<%@include file="/purchase/common/common.jsp"%>
<html>
<head>
<title>月度计划填报</title>
	<style type="text/css">
	    body{
	        margin:0;padding:0;border:0;width:100%;height:100%;overflow:hidden;
	    }
    </style>
</head>
<body>
 <%long workitemid = (Long)request.getAttribute("workItemID");%> 
	<div class="nui-fit">
		<fieldset style="border:solid 1px #aaa;padding:10px 5px 15px;">
		<legend>重点任务基本信息</legend>
		 	<form id="form1" method="post"  style="width:100%;height:100%" >
	        	<table style="table-layout:fixed; border-spacing:5px " id="table_file1"  >
	        			<input class="nui-hidden" id="keytaskId" >
			            <tr>
							<td align="right" style="width:128px">重点任务名称：</td>
							<td  colspan="2";>
								<input class="nui-textbox" name="taskName" id="taskName" style="width:200px" readOnly="readOnly">
							</td>
							<td align="right" style="width:128px">重点任务方向：</td>
							<td  colspan="2";>
								<input class="nui-textbox" name="taskDirection" id="taskDirection" style="width:200px" required="true" onblur="checkProjectno" readOnly="readOnly">
							</td>	
							<td align="right" style="width:128px">责任单位：</td>
							<td  colspan="2" style="width: 210px;"><input
									name="orgId" id="orgId"
									class="nui-combobox" required="true"
									url="com.primeton.rdmgr.labor.labormgr.getAllOrgs.biz.ext"
									filterType="like" textField="orgname" valueField="orgid"
									dataField="allorgs" valueFromSelect="true" allowInput="true"
									onvaluechanged="changeOrgForm" style="width: 241px;" readOnly="readOnly" /></td>	
						</tr>
						<tr>
							
							<td align="right" style="width:128px">年度：</td>
							<td  colspan="2";>
								<input class="mini-spinner" minValue="2021" maxValue="2100" name="declareYear" id="declareYear" style="width:200px" shownullItem="true" readOnly="readOnly">
							</td>		
							
							<td align="right" style="width:128px"> 计划完成时间：</td>
							<td style="width: 130px"><input
									name="planCompleteTime" id="planCompleteTime"
									class="nui-datepicker" required="true" style="width: 200px" readOnly="readOnly"/></td>
							
						</tr>
						<tr>
							<td align="right" style="width:128px">总体目标：</td>
							<td  colspan="8";>
							<input class="nui-textarea"  name="populationTarget" id="populationTarget" style="width:950px;height: 50px" required="true" readOnly="readOnly">
							</td>
						</tr>
						<tr>
							<td align="right" style="width:128px">年度目标：</td>
							<td  colspan="8";>
								<input name="yearTarget" id="yearTarget" class="nui-textarea" style="width:950px;height: 50px" showClose="false" allowInput="true" required="true" readOnly="readOnly"/>
							</td>
						</tr>
						<tr>
							<td align="right" style="width:128px">决策情况：</td>
							<td  colspan="8";>
								<input class="nui-textarea" name="decisionSituation" id="decisionSituation"  style="width:950px;height: 40px" shownullItem="true" required="true" readOnly="readOnly">
							</td>
						</tr>
	        	</table>
	        </form>
    	</fieldset>
		 <fieldset style="border: solid 1px #aaa;padding: 3px;width: 97%;">
			    <legend>重点任务月度计划 </legend>
		<div style="width:auto;">
        <div class="nui-toolbar" id="id2" style="border-bottom:0;padding:0px;" >
            <table style="width:auto;">
                <tr>
                    <td style="width:97%;">
                        <a class="nui-button" iconCls="icon-edit" onclick="edit()" plain="true">编辑</a>
                        <a class="nui-button" iconCls="icon-import" onclick="importMonthPlan()" plain="true">月度计划导入</a>
                    </td>
                </tr>
            </table>           
        </div>
	</div> 
	<div id="datagrid2" class="nui-datagrid" style="width:97%;height:auto;" dataField="monthTaskList"  url="com.zhonghe.ame.imptask.keytask.queryMonthTask.biz.ext"
 		allowResize="true" pageSize="20" allowCellEdit="true"  editNextOnEnterKey="true" showpager="false">
	    <div property="columns"> 
	 		<div name="temp123" type="checkcolumn"></div>
        	<div field="month" width="40" align="center" headerAlign="center" allowSort="true">月份</div>
            <div field="monthDescribe" width="120" align="center" headerAlign="center" allowSort="true">月度计划描述</div>
         	 <div field="actualCompleteTime" width="90" align="center" headerAlign="center" allowSort="true" >实际完成时间</div> 
            <div field="completion" width="80" align="center" headerAlign="center" allowSort="true"  >进展情况</div>
            <div field="problemMeasures" width="100" align="center" headerAlign="center" allowSort="true">问题及纠偏措施</div>
            <div field="completeStatus" width="80" align="center" headerAlign="center" renderer="check">完成状态</div>
            <div field="completeRate" width="80" align="center" headerAlign="center" >完成率（%）</div>
	    </div>
	</div>
	</fieldset> 
	</div> 
	<jsp:include page="/ame_common/misOpinion.jsp"/>
	<div style="text-align:center;padding:10px;" class="nui-toolbar">
		<a class="nui-button" onclick="submit()" id="appButton" style="width:60px;margin-right:20px;">提交</a>
		<a class="nui-button" onclick="onCancel('cancel')" style="width:60px;">关闭</a>
	</div>

    <script type="text/javascript">
		nui.parse();
    	var form = new nui.Form("form1");
    	var workItemID = <%=request.getParameter("workItemID")%>;
    	var opioionform = new nui.Form("#opioionform");
    	var grid_traveldetail = nui.get('grid_traveldetail');
    	
    	document.getElementById("auditop").style.display="none";
    	document.getElementById("datagrid1").style.display="none";
    	document.getElementById("auditopinion").style.display="none";
    	document.getElementById("opioionform").style.display="none";
    	document.getElementById("salesEdit").style.display="none";
    	
    	nui.get("auditopinion").setValue("月度计划填报");
    	var grid_cont = nui.get("grid_cont");//项目合同
    	var save = "0";
    	var projectno1;
    	var remindfz = nui.getDictText('AME_SYSCONF',"projectYZ");
    	var grid = nui.get("datagrid2");
    	function init(){ 
			var data = {workitemid:<%=workitemid%>};
			var json = nui.encode(data);
			nui.ajax({
		        url: "com.zhonghe.ame.imptask.keytask.queryTaskMngInfo.biz.ext",
		        type: "post",
		        data: json ,
		        contentType:'text/json',
		        success: function (o) {
			            form.setData(o);
			            
			            nui.get("taskName").setValue(o.keyTask.taskName);
			            nui.get("taskDirection").setValue(o.keyTask.taskDirection);
			            
			            nui.get("orgId").setText(o.keyTask.orgname);

				        nui.get("planCompleteTime").setValue(o.keyTask.planCompleteTime);
	        
				        nui.get("yearTarget").setValue(o.keyTask.yearTarget);
				        nui.get("populationTarget").setValue(o.keyTask.populationTarget);
				        nui.get("decisionSituation").setValue(o.keyTask.decisionSituation);

			            nui.get("declareYear").setValue(o.keyTask.declareYear);
			            nui.get("keytaskId").setValue(o.keyTask.id);
			            
						grid.load({id:o.keyTask.id});
						
			            //流程提示信息
			            // promptInit({"workItemID": <%=workitemid%>});
			            
						
						//初始化处理意见
						initMisOpinion({auditstatus:"1"});

			        }
			    });
		 				
						
		 }
		init();
	    
	    function importMonthPlan(){
	    	var value = nui.get("keytaskId").getValue();
	    	nui.open({
		        url: "/default/imptask/importKeyTaskMonth.jsp?keytaskId="+value,
	            title: "导入", 
				width: 700,
	            height: 230,
	            allowDrag:true,
	            onload: function () {
					var iframe = this.getIFrameEl();
				},
				ondestroy: function (action){
					init();
				}
    		});
	    	    
	    }
	    
	    function search(){
	    grid.load({id:o.keyTask.id});
	    
	    }
	    
	    function check(e){
	    	
			if(e.value==1){
			return "已完成";
			}else if(e.value==0){
			return "进行中";
			}else{
			return "";
			}
		}
	    	
    	
    	//修改投标明细
		function edit(){
			
    		var row = grid.getSelecteds();
			if (row.length > 1) {
    		nui.alert("只能选中一条项目记录进行编辑");
    		}else{
    		var row=row[0];
    		
			if (row) {
				nui.open({
				
				 url: "/default/imptask/editMonthTask.jsp?keyId="+row.id,
				width: 1000,
				height: 300,
				onload: function () {
					var iframe = this.getIFrameEl();
				},
				ondestroy: function (action) {
	            	if(action=="ok"){
	            		grid.reload();
	            	}
	            }
			}) 
			
			}else{
				nui.alert("请选中一条记录","提示");
			}
			
    		}
		}
    	
    	function addTicket(){
    	var rowS = {name: "New Row"} 
		grid_traveldetail.addRow(rowS);
    	<%--var row = grid_traveldetail.getData();
    	if(row.length==0){
    		var rowS = {name: "New Row"} 
    		grid_traveldetail.addRow(rowS);
    	}else{
    		var rowS = {name: "New Row",bookingregion:row[0].bookingregion};
    		grid_traveldetail.addRow(rowS);
    	}--%>
    }
    
	//删除行程明细
	function removeTicket(){
		var rows = grid_traveldetail.getSelecteds();
        if (rows.length>0) {
            grid_traveldetail.removeRows(rows, true);
        }else{
        	nui.alert("请至少选中一条记录！");
        }
	}
    	
    	

	//对应类型业务字典
	function dictGetType(e){
		return nui.getDictText('AME_PROCONT',e.value);
	}
	
	function submit(){
	    	var auditstatus = nui.get("auditstatus").getValue();
	    	
	    	if(auditstatus == "2"){	//终止流程
	    		titleText = "终止";
	    		submitProcess("终止");
	    	}else if(auditstatus == "0"){	//退回流程
	    		if(!nui.get("backTo").getValue()){
	    			nui.alert("退回环节不能为空！");
	    			return;
	    		}
	    		titleText = "退回";
	    		submitProcess("退回");
	    	}else if(auditstatus == "1"){	//提交流程
	    		titleText = "提交";
	    		submitProcess("提交");
	    	}
    }
	
	
	
	 // 提交 
    function submitProcess(title){
    	nui.confirm("确定" + title + "流程吗？", "操作提示",function (action) {            
            if (action == "ok") {
				var misOpinion = opioionform.getData().misOpinion;//审核意见
            	nui.get("appButton").setEnabled(false);
            	var json = {misOpinion:misOpinion,workItemID: <%=workitemid %>};
            	saveData(json);
            }
        });
    }
    

	function updateRdproject(){
		if(form.validate()){
			if(!checkTime()){
				return;
			}else{
				form2.submit();
			}
		}else{
			alert("请检查表单的完整性!");
			return;
		}
	}
	
	
	function saveData(json){
			
			 mini.mask({
		            el: document.body,
		            cls: 'mini-mask-loading',
		            html: titleText+'中...'
		        }); 
		    	  nui.ajax({
		  			url: "com.zhonghe.ame.imptask.keytask.depAppMonthTask.biz.ext",
					type: "post",
					data: json,
					contentType: "text/json",
					success: function (o){
						nui.unmask(document.body);
						if(o.result == "success"){
				        	nui.alert(titleText + "成功","系统提示",function(){
				        		//nui.get("sureButton").setEnabled(true);
				        		CloseWindow("ok");
				        	});
						}else{
							nui.alert("提交失败，请联系信息技术部人员！","系统提示", function(action){
								//nui.get("sureButton").setEnabled(true);
							    CloseWindow("ok");
								
							});
						}
					},
					error: function(jqXHR, textStatus, errorThrown){
						alert(jqXHR.responseText);
					}
		  		})  
	
	
	
	
	}
	
	
	function CloseWindow(action) {            
        if (action == "close" && form.isChanged()) {
            if (confirm("数据被修改了，是否先保存？")) {
                return false;
            }
        }
        if (window.CloseOwnerWindow) return window.CloseOwnerWindow(action);
        else window.close();            
    }

    function onCancel(e) {
        CloseWindow("cancel");
        window.opener.search();
    }
    
    //设置日期格式
	function onDealDate(e){
		if(e.cellHtml){
			return e.cellHtml.substring(0,10);
		}
	}
	
	//单元格开始编辑前，判断对应类型是否合同编号，如果是则允许编辑合同订单，如果不是则不允许编辑合同订单
	function checkOrder(e){
		if(e.field=="contorderno"){
			if(e.record.proconttype=="1"){
				e.cancel = true;
			}
		}
	}
	
	//当项目合同对应类型为项目与合同对应时清空合同订单
	function clearOrder(e){
		if(e.field=="proconttype"){
			if(e.value=="1"){
				var row = e.record;
				var rowData = {"contorderno":""};
				grid_cont.updateRow(row,rowData);
			}
		}
	}
	//预计合同改变 + 预计合同额expcontsum数字验证
	function changeexpcontsum(e){
		var remindfz = nui.get("remindfz").getValue();
		if(!remindfz){//如果为空，则根据预计合同额按比例计算
			calRemindfz();
		}
		//预计合同额expcontsum数字验证
		checkNum1();
	}
	
	//按比例计算阈值
	function calRemindfz(){
		var expcontsum = nui.get("expcontsum").getValue();
		if(!expcontsum){
			nui.alert("请先填写预计合同额！");
			return;
		}else{
			var projectYZRatio = nui.getDictText('AME_SYSCONF','projectYZRatio');//比例
			var remindfz = Math.round(parseFloat(expcontsum)*parseFloat(projectYZRatio));
			nui.get("remindfz").setValue(remindfz);
		}
	}
	
	//是否是数字
  	function IsNumber(num){
		var strRegex = "^\\d+(\\.\\d+)?$";
		var re=new RegExp(strRegex); 
		//re.test()
		if (re.test(num)){
			return (true); 
		}else{ 
			return (false); 
		}
	}
	
	//预计合同额expcontsum数字验证
	function checkNum1(){
		var expcontsum = nui.get("expcontsum").getValue();
		if(IsNumber(expcontsum)==false){
			alert("请输入正确数字格式！");
			nui.get("expcontsum").setValue("");
			return;
		}
	}
	function setColor(e){
		var row = e.record;
	    if (e.field == "traffictype") {
	        if(e.value == "2" || e.value == "4"){
		         e.cellStyle = "background:yellow";
    		}
	    }
	    if(e.field == "timequantums" || e.field == "timequantume" ||e.field == "bookingregion" ){
	    	if(row.bookingtype == "2"){
	    		e.value = "";
	    		e.cellHtml = "";
	    		row.timequantums = "";
	    		row.timequantume = "";
	    		row.bookingregion = "";
	    	}
	    }
	}
   	</script>
</body>
</html>